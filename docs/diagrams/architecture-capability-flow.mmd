%%{init: {
  "theme": "base",
  "themeVariables": {
    "fontFamily": "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
    "fontSize": "14px",
    "primaryColor": "rgba(59,130,246,0.10)",
    "primaryTextColor": "#0f172a",
    "primaryBorderColor": "rgba(15,23,42,0.30)",
    "lineColor": "#1f2937",
    "tertiaryColor": "rgba(15,23,42,0.02)"
  },
  "flowchart": { "curve": "basis", "nodeSpacing": 55, "rankSpacing": 70 }
}}%%

flowchart TB

  %% =========================
  %% VeridianOS Architecture
  %% Normative: invariants + capability flow + kernel entry points
  %% =========================

  subgraph SYS["System Boundary -- Isolation boundaries are architectural, authority is explicit"]
    direction TB

    %% --- Top row ---
    subgraph TOP[" "]
      direction LR
      BOOT["Firmware / Bootloader<br>boot entry establishes kernel control<br>bounded trust - early boot is part of TCB"]
      KERNEL["Kernel - TCB<br>enforces isolation - mediates capabilities - manages memory ownership<br>entry: boot / interrupts / exceptions / syscalls<br>TCB minimal - authority deliberate"]
      DRV["Drivers<br>hardware behind explicit privilege boundaries<br>no bypass of kernel mediation"]
    end

    %% --- Middle row ---
    subgraph MID[" "]
      direction LR
      IPC[("IPC Channel<br>transport, not an authority source<br>endpoints are capabilities - message passing default<br>shared memory requires explicit setup")]
      SVC["Services<br>capability-mediated system functionality<br>routers, not authorities - failure contained"]
    end

    %% --- Bottom row ---
    USER["Userland<br>intentionally constrained processes<br>no ambient authority - access only via capabilities"]

    %% --- Kernel-internal authority capsule ---
    CAPAUTH[["Capability Authority<br>create - validate - transfer - revoke<br>unsafe invariant-bound"]]

    %% --- Exceptional shared memory note ---
    SHMNOTE[/"Shared Memory - Exceptional<br>capability-governed - explicit lifetime<br>deliberate aliasing only"/]
  end

  %% =========================
  %% Flows
  %% =========================

  BOOT -->|boot entry| KERNEL

  USER -->|syscalls| KERNEL
  DRV  -->|interrupt/exception entry| KERNEL
  KERNEL -->|hardware caps| DRV

  %% IPC is a transport overlay
  USER -.->|IPC via endpoints| IPC
  SVC  -.->|IPC via endpoints| IPC

  %% Capability grants / delegation
  KERNEL -->|service caps| SVC
  SVC -.->|cap transfer request| KERNEL
  KERNEL -.->|cap transfer delivery| USER

  %% Boundary checks + mediation
  KERNEL -->|endpoint + cap validation| CAPAUTH
  CAPAUTH --> KERNEL

  %% Shared memory is exceptional, capability-gated
  IPC -.->|optional, explicit setup| SHMNOTE

  %% =========================
  %% Styling
  %% =========================
  classDef boot fill:rgba(100,116,139,0.10),stroke:rgba(15,23,42,0.30),stroke-width:2px,color:#0f172a
  classDef kernel fill:rgba(59,130,246,0.10),stroke:rgba(15,23,42,0.30),stroke-width:2px,color:#0f172a
  classDef driver fill:rgba(168,85,247,0.10),stroke:rgba(15,23,42,0.30),stroke-width:2px,color:#0f172a
  classDef service fill:rgba(245,158,11,0.12),stroke:rgba(15,23,42,0.30),stroke-width:2px,color:#0f172a
  classDef user fill:rgba(16,185,129,0.10),stroke:rgba(15,23,42,0.30),stroke-width:2px,color:#0f172a
  classDef ipc fill:rgba(14,165,233,0.06),stroke:rgba(14,165,233,0.45),stroke-width:2px,stroke-dasharray:6 4,color:#0f172a
  classDef note fill:rgba(15,23,42,0.03),stroke:rgba(15,23,42,0.22),stroke-width:2px,stroke-dasharray:8 6,color:#0f172a
  classDef cap fill:rgba(255,255,255,0.62),stroke:rgba(15,23,42,0.22),stroke-width:2px,color:#0f172a

  class BOOT boot
  class KERNEL kernel
  class DRV driver
  class SVC service
  class USER user
  class IPC ipc
  class SHMNOTE note
  class CAPAUTH cap

  linkStyle 7 stroke:#475569,stroke-width:2px,stroke-dasharray:6 4
  linkStyle 8 stroke:#475569,stroke-width:2px,stroke-dasharray:6 4
  linkStyle 10 stroke:#475569,stroke-width:2px
