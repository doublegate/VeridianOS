%%{init: {
  "theme": "base",
  "themeVariables": {
    "fontFamily": "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
    "fontSize": "14px",
    "primaryColor": "#dbeafe",
    "primaryTextColor": "#0f172a",
    "primaryBorderColor": "#6b7280",
    "lineColor": "#1f2937",
    "tertiaryColor": "#f8fafc"
  },
  "flowchart": { "curve": "basis", "nodeSpacing": 55, "rankSpacing": 70 }
}}%%

flowchart TB

  %% =========================
  %% VeridianOS Architecture
  %% Normative: invariants + capability flow + kernel entry points
  %% =========================

  subgraph SYS["System Boundary -- Isolation boundaries are architectural, authority is explicit"]
    direction TB

    %% --- Top row ---
    subgraph TOP[" "]
      direction LR
      BOOT["Firmware / Bootloader<br>boot entry establishes kernel control<br>bounded trust - early boot is part of TCB"]
      KERNEL["Kernel - TCB<br>enforces isolation - mediates capabilities - manages memory ownership<br>entry: boot / interrupts / exceptions / syscalls<br>TCB minimal - authority deliberate"]
      DRV["Drivers<br>hardware behind explicit privilege boundaries<br>no bypass of kernel mediation"]
    end

    %% --- Middle row ---
    subgraph MID[" "]
      direction LR
      IPC[("IPC Channel<br>transport, not an authority source<br>endpoints are capabilities - message passing default<br>shared memory requires explicit setup")]
      SVC["Services<br>capability-mediated system functionality<br>routers, not authorities - failure contained"]
    end

    %% --- Bottom row ---
    USER["Userland<br>intentionally constrained processes<br>no ambient authority - access only via capabilities"]

    %% --- Kernel-internal authority capsule ---
    CAPAUTH[["Capability Authority<br>create - validate - transfer - revoke<br>unsafe invariant-bound"]]

    %% --- Exceptional shared memory note ---
    SHMNOTE[/"Shared Memory - Exceptional<br>capability-governed - explicit lifetime<br>deliberate aliasing only"/]
  end

  %% =========================
  %% Flows
  %% =========================

  BOOT -->|boot entry| KERNEL

  USER -->|syscalls| KERNEL
  DRV  -->|interrupt/exception entry| KERNEL
  KERNEL -->|hardware caps| DRV

  %% IPC is a transport overlay
  USER -.->|IPC via endpoints| IPC
  SVC  -.->|IPC via endpoints| IPC

  %% Capability grants / delegation
  KERNEL -->|service caps| SVC
  SVC -.->|cap transfer request| KERNEL
  KERNEL -.->|cap transfer delivery| USER

  %% Boundary checks + mediation
  KERNEL -->|endpoint + cap validation| CAPAUTH
  CAPAUTH --> KERNEL

  %% Shared memory is exceptional, capability-gated
  IPC -.->|optional, explicit setup| SHMNOTE

  %% =========================
  %% Styling
  %% =========================
  classDef boot fill:#e8eaed,stroke:#6b7280,stroke-width:2px,color:#0f172a
  classDef kernel fill:#dbeafe,stroke:#6b7280,stroke-width:2px,color:#0f172a
  classDef driver fill:#ede9fe,stroke:#6b7280,stroke-width:2px,color:#0f172a
  classDef service fill:#fef3c7,stroke:#6b7280,stroke-width:2px,color:#0f172a
  classDef user fill:#d1fae5,stroke:#6b7280,stroke-width:2px,color:#0f172a
  classDef ipc fill:#f0f9ff,stroke:#7dd3fc,stroke-width:2px,stroke-dasharray:6 4,color:#0f172a
  classDef note fill:#f8fafc,stroke:#cbd5e1,stroke-width:2px,stroke-dasharray:8 6,color:#0f172a
  classDef cap fill:#ffffff,stroke:#cbd5e1,stroke-width:2px,color:#0f172a

  class BOOT boot
  class KERNEL kernel
  class DRV driver
  class SVC service
  class USER user
  class IPC ipc
  class SHMNOTE note
  class CAPAUTH cap

  linkStyle 7 stroke:#475569,stroke-width:2px,stroke-dasharray:6 4
  linkStyle 8 stroke:#475569,stroke-width:2px,stroke-dasharray:6 4
  linkStyle 10 stroke:#475569,stroke-width:2px
