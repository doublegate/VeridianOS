From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: VeridianOS <veridian@veridian-os.org>
Date: Mon, 17 Feb 2026 00:00:00 +0000
Subject: [PATCH 1/2] Add VeridianOS target support to GCC

Teach GCC 14.2.0 to recognize x86_64-veridian, aarch64-veridian,
and riscv64-veridian as valid cross-compilation targets.

New files:
  - gcc/config/veridian.h: VeridianOS target OS header defining
    __veridian__, startup file specs, and linker defaults.
  - gcc/config/t-veridian: VeridianOS makefile fragment (no multilib).

Modified files:
  - gcc/config.gcc: Add veridian target cases for x86_64, aarch64,
    and riscv64, wiring in the veridian.h header and t-veridian
    makefile fragment.
  - libgcc/config.host: Add libgcc support (crtbegin/crtend) for
    all three veridian architectures.
  - fixincludes/mkfixinc.sh: Skip fixincludes for veridian targets
    (VeridianOS provides its own headers).
---
 gcc/config.gcc          | 27 ++++++++++++++++++++++
 gcc/config/veridian.h   | 70 +++++++++++++++++++++++++++++++++++++++++++++++++
 gcc/config/t-veridian   |  8 ++++++
 libgcc/config.host      | 15 +++++++++++
 fixincludes/mkfixinc.sh |  1 +
 5 files changed, 121 insertions(+)
 create mode 100644 gcc/config/veridian.h
 create mode 100644 gcc/config/t-veridian

--- a/gcc/config.gcc
+++ b/gcc/config.gcc
@@ -1227,6 +1227,12 @@
 	done
 	TM_MULTILIB_CONFIG=`echo $TM_MULTILIB_CONFIG | sed 's/^,//'`
 	;;
+aarch64*-*-veridian*)
+	tm_file="${tm_file} elfos.h newlib-stdint.h"
+	tm_file="${tm_file} aarch64/aarch64-elf.h aarch64/aarch64-errata.h veridian.h"
+	tmake_file="${tmake_file} aarch64/t-aarch64 t-veridian"
+	use_gcc_stdint=wrap
+	;;
 aarch64*-*-freebsd*)
 	tm_file="${tm_file} elfos.h ${fbsd_tm_file}"
 	tm_file="${tm_file} aarch64/aarch64-elf.h aarch64/aarch64-errata.h aarch64/aarch64-freebsd.h"
@@ -1938,6 +1944,16 @@
 x86_64-*-rtems*)
 	tm_file="${tm_file} i386/unix.h i386/att.h elfos.h newlib-stdint.h i386/i386elf.h i386/x86-64.h i386/rtemself.h rtems.h"
 	;;
+x86_64-*-veridian*)
+	tm_file="${tm_file} i386/unix.h i386/att.h elfos.h newlib-stdint.h i386/i386elf.h i386/x86-64.h veridian.h"
+	tmake_file="${tmake_file} i386/t-x86_64-elf t-veridian"
+	use_gcc_stdint=wrap
+	;;
+i[34567]86-*-veridian*)
+	tm_file="${tm_file} i386/unix.h i386/att.h elfos.h newlib-stdint.h i386/i386elf.h veridian.h"
+	tmake_file="${tmake_file} t-veridian"
+	use_gcc_stdint=wrap
+	;;
 i[34567]86-*-rdos*)
     tm_file="${tm_file} i386/unix.h i386/att.h elfos.h newlib-stdint.h i386/i386elf.h i386/rdos.h"
     ;;
@@ -2532,6 +2548,11 @@
 	# automatically detect that GAS supports it, yet we require it.
 	gcc_cv_initfini_array=yes
 	;;
+riscv*-*-veridian*)
+	tm_file="elfos.h newlib-stdint.h ${tm_file} riscv/elf.h veridian.h"
+	tmake_file="${tmake_file} riscv/t-riscv t-veridian"
+	use_gcc_stdint=wrap
+	;;
 riscv*-*-freebsd*)
 	tm_file="${tm_file} elfos.h ${fbsd_tm_file} riscv/freebsd.h"
 	tmake_file="${tmake_file} riscv/t-riscv"
--- /dev/null
+++ b/gcc/config/veridian.h
@@ -0,0 +1,70 @@
+/* Target configuration for VeridianOS.
+   Copyright (C) 2026 Free Software Foundation, Inc.
+
+   This file is part of GCC.
+
+   GCC is free software; you can redistribute it and/or modify it
+   under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3, or (at your option)
+   any later version.
+
+   GCC is distributed in the hope that it will be useful, but WITHOUT
+   ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
+   License for more details.
+
+   Under Section 7 of GPL version 3, you are granted additional
+   permissions described in the GCC Runtime Library Exception, version
+   3.1, as published by the Free Software Foundation.
+
+   You should have received a copy of the GNU General Public License
+   and a copy of the GCC Runtime Library Exception along with this
+   program; see the files COPYING3 and COPYING.RUNTIME respectively.
+   If not, see <http://www.gnu.org/licenses/>.  */
+
+/* VeridianOS -- capability-based microkernel operating system.
+
+   This header defines the target OS builtins, link specs, and startup
+   file references for VeridianOS.  It is included last in the tm_file
+   list so that it can override settings from architecture-specific
+   headers.  */
+
+#undef  TARGET_OS_CPP_BUILTINS
+#define TARGET_OS_CPP_BUILTINS()        \
+  do {                                  \
+    builtin_define ("__veridian__");     \
+    builtin_define ("__unix__");         \
+    builtin_assert ("system=veridian"); \
+    builtin_assert ("system=unix");     \
+    builtin_assert ("system=posix");    \
+  } while (0)
+
+/* Use standard ELF sections.  */
+#define OBJECT_FORMAT_ELF
+
+/* Default linker emulation -- overridden per-arch where needed.  */
+#undef  GNU_USER_LINK_EMULATION
+#define GNU_USER_LINK_EMULATION "elf_x86_64"
+
+/* C runtime startup files.  crt0.o is provided by the VeridianOS libc
+   (userland/libc/crt0.S).  crti.o and crtn.o bracket .init/.fini.  */
+#undef  STARTFILE_SPEC
+#define STARTFILE_SPEC "crt0.o%s crti.o%s crtbegin.o%s"
+
+#undef  ENDFILE_SPEC
+#define ENDFILE_SPEC "crtend.o%s crtn.o%s"
+
+/* Link against the VeridianOS C library.  */
+#undef  LIB_SPEC
+#define LIB_SPEC "-lc"
+
+/* Linker flags: 4 KiB page size (all three architectures), static by
+   default since VeridianOS does not yet have a dynamic linker.  */
+#undef  LINK_SPEC
+#define LINK_SPEC "-z max-page-size=4096 %{!shared: %{!static: -static}}"
+
+/* Simplify the GCC internal link sequence -- no crt* magic beyond what
+   STARTFILE_SPEC / ENDFILE_SPEC already request.  */
+#undef  LINK_GCC_C_SEQUENCE_SPEC
+#define LINK_GCC_C_SEQUENCE_SPEC "%G %L"
+
+/* No multilib support.  */
+#undef  MULTILIB_DEFAULTS
+#define MULTILIB_DEFAULTS { "" }
+
+/* Thread model -- single for now (no pthreads yet).  */
+#undef  THREAD_MODEL_SPEC
+#define THREAD_MODEL_SPEC "single"
--- /dev/null
+++ b/gcc/config/t-veridian
@@ -0,0 +1,8 @@
+# Makefile fragment for VeridianOS targets.
+#
+# No extra multilib configurations -- VeridianOS uses a single ABI per
+# architecture (LP64 for all three: x86_64, AArch64, RISC-V 64).
+
+MULTILIB_OPTIONS =
+MULTILIB_DIRNAMES =
+MULTILIB_OSDIRNAMES =
--- a/libgcc/config.host
+++ b/libgcc/config.host
@@ -418,6 +418,11 @@
 	tmake_file="${tmake_file} t-dfprules"
 	md_unwind_header=aarch64/aarch64-unwind.h
 	;;
+aarch64*-*-veridian*)
+	extra_parts="crtbegin.o crtend.o"
+	tmake_file="${tmake_file} ${cpu_type}/t-aarch64"
+	tmake_file="${tmake_file} t-crtstuff"
+	;;
 aarch64*-*-freebsd*)
 	extra_parts="$extra_parts crtfastmath.o"
 	tmake_file="${tmake_file} ${cpu_type}/t-aarch64"
@@ -749,6 +754,11 @@
 	    ;;
 	esac
 	;;
+x86_64-*-veridian*)
+	extra_parts="crtbegin.o crtend.o"
+	tmake_file="${tmake_file} i386/t-crtstuff"
+	tmake_file="${tmake_file} t-crtstuff"
+	;;
 x86_64-*-fuchsia*)
 	tmake_file="$tmake_file t-libgcc-pic"
 	;;
@@ -1356,6 +1366,11 @@
 	tmake_file="${tmake_file} riscv/t-crtstuff riscv/t-softfp${host_address} t-softfp riscv/t-elf riscv/t-elf${host_address} t-slibgcc-libgcc"
 	extra_parts="$extra_parts crtbegin.o crtend.o crti.o crtn.o crtendS.o crtbeginT.o"
 	;;
+riscv*-*-veridian*)
+	extra_parts="crtbegin.o crtend.o"
+	tmake_file="${tmake_file} ${cpu_type}/t-crtstuff"
+	tmake_file="${tmake_file} t-crtstuff"
+	;;
 riscv*-*-*)
 	tmake_file="${tmake_file} riscv/t-softfp${host_address} t-softfp riscv/t-elf riscv/t-elf${host_address}"
 	extra_parts="$extra_parts crtbegin.o crtend.o crti.o crtn.o"
--- a/fixincludes/mkfixinc.sh
+++ b/fixincludes/mkfixinc.sh
@@ -20,6 +20,7 @@
     powerpcle-*-eabisim* | \
     powerpcle-*-eabi* | \
     *-*-vxworks7* | \
+    *-*-veridian* | \
     *-musl* )
 	#  IF there is no include fixing,
 	#  THEN create a no-op fixer and exit
--
2.47.1

