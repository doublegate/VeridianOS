# Portfile.toml -- Ninja for VeridianOS
#
# Ninja is a small build system with a focus on speed.  It differs from
# other build systems in two major respects: it is designed to have its
# input files be generated by a higher-level build system (such as CMake
# or Meson), and it is designed to run builds as fast as possible.
#
# For VeridianOS, Ninja is cross-compiled statically since the OS has no
# dynamic linker.  The build uses direct compilation of source files
# rather than Ninja's own bootstrap process, enabling straightforward
# cross-compilation.
#
# Build script: scripts/build-native-ninja.sh

[port]
name = "ninja"
version = "1.12.1"
description = "Ninja -- small build system with a focus on speed"
homepage = "https://ninja-build.org/"
license = "Apache-2.0"
category = "devel"
build_type = "custom"

[sources]
urls = ["https://github.com/ninja-build/ninja/archive/refs/tags/v1.12.1.tar.gz"]
checksums = ["821bdff48a3f683bc4bb3b6f0b5fe7b2d647cf65d52a1571cc550d03f16c99ea"]

[dependencies]
build = []
runtime = []

# Cross-compilation build (build=linux, host=veridian)
#
# Ninja's source is compiled directly with the cross-compiler.  The build
# does not use Ninja's own configure.py bootstrap since it does not support
# cross-compilation natively.
#
# Requires: C++ cross-compiler (x86_64-veridian-g++ from Stage 2.5)
[build]
patches = []
steps = [
    # Compile all source files with the cross-compiler
    "CXX=$VERIDIAN_TARGET-g++ CXXFLAGS='-O2 -static -fno-exceptions -fno-rtti -DNINJA_HAVE_FORK' LDFLAGS='-static' python3 configure.py --host=linux",
    # Manual cross-compile: compile each .cc file and link
    # (see scripts/build-native-ninja.sh for the full automated process)
]
notes = """
Ninja is cross-compiled using direct source compilation rather than the
standard bootstrap process.  This is because configure.py does not support
--host= for cross-compilation.

The recommended way to build Ninja for VeridianOS is:
  ./scripts/build-native-ninja.sh

Or as part of the full tools build:
  ./scripts/build-native-tools.sh

Ninja requires the C++ cross-compiler (x86_64-veridian-g++).  If only the
C cross-compiler is available, build it first:
  ./scripts/build-native-gcc.sh  (provides Stage 2.5 with C++ support)
"""
